---
title: "Coronavirus SARS-CoV-2 / Covid-19"
author: "Wolfgang Vollmer"
date: '`r Sys.Date()`'
link-citations: yes
cite-color: "green"
bibliography: References_Corona.bib
output:
   flexdashboard::flex_dashboard:
   vertical_layout: scroll
params:
  device: "desktop"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE,      
                      message = FALSE, fig.width = 7, fig.asp = 0.618)

# csl: "./../Bibliography/bluebook-law-review.csl"
# csl: bluebook-law-review.csl
# csl: harvard1.csl
# csl: ieee.csl

#===============================================================================
#
#  Corona Virus -
#        Analyze Time Series of Confirmed and Death and Cases
#
#                                           Wolfgang Vollmer,  October 30, 2020
#                                               First Version:   March 12, 2020
#
#  URL:
#  https://github.com/WoVollmer/R-TimesSeriesAnalysis/tree/master/Corona-Virus
#===============================================================================
library(flexdashboard)
library(tidyverse)
library(magrittr)
library(lubridate)
library(slider) # for rolling analysis using window functions
library(fpp3)  # tsibble, tsibbledata, fable, and feasts packages & some tidyverse
library(slider) # sliding window functions - rolling averages, cumulative sums
library(DT)      # R interface to the JavaScript library DataTables
library(patchwork) # package for composing plots
          # https://www.data-imaginist.com/2019/patch-it-up-and-send-it-out/
library(gghighlight) 
# https://cran.r-project.org/web/packages/gghighlight/vignettes/gghighlight.html
# library(gridExtra)
# library(janitor)
library(plotly)
library(highcharter)
library(dygraphs)  # R interface to the dygraphs JavaScript charting library
library(checkmate) # to provide informative error messages
library(pkgTS) # TimeSeries Funcstion - own R package on GitHub
               # devtools::install_github("WoVollmer/pkgTS")

```

```{r setwd change, eval = FALSE}

# knit: changes working dir => path of *.RMD file => setwd() not needed !
# R code run: RStudio project R_TimeSeriesAnalysis needs 
# relative working dir change (eval = FALSE needed for knitr runs!!) 

setwd("./Corona-Virus/") 

```

```{r data path desktop vs. notebook, eval = TRUE}
# device <- "desktop" # "notebook"  # to define setwd() and data path
# defined as params  metadata in YAML header
device <- params$device

if (device == "desktop") {
  data_path <- 
    "D:/Wolfgang/WoDocs/GitHub/COVID-19/csse_covid_19_data/csse_covid_19_time_series"
  setwd("D:/Wolfgang/Programs-R/R-TimeSeriesAnalysis/Corona-Virus")
} else if (device == "notebook") {
  data_path <- 
    "C:/Wolfgang/Programs-R/COVID-19/csse_covid_19_data/csse_covid_19_time_series"
  # attention: for "notebook" & "linux" TimesSer.. (Time + plural-s) is needed
  #                       (whyever) not TimeSer..
  setwd("C:/Wolfgang/Programs-R/R-TimesSeriesAnalysis/Corona-Virus")
} else if (device == "linux") {
  data_path <- 
    "/home/wolfgang-ubuntu/GitHub/COVID-19/csse_covid_19_data/csse_covid_19_time_series"
    setwd("/home/wolfgang-ubuntu/Programs-R/R-TimesSeriesAnalysis/Corona-Virus")
} else {
  stop("no valid device outlined")
}

```

```{r source function and population data}
# Plot and util functions - has to come after setwd()  ------------
# sources part of library(pkgTS) # devtools::install_github("WoVollmer/pkgTS")
#     all needed function files via library(pgkTS)
#     - ggts_corona.R # ggplot2 functions for time series plots
#     - uts_corona.R  # utility functions for corona analysis
# read UN world population data for normalization per 100k inhabitants

population_countries <- readRDS("./world_population_un.RDS") # data from UN

```


```{r initialization, eval = TRUE, include = FALSE}

# variables clean up, library() and	source() statements ----------------------
# deletes params$device => not allowed
# rm(list=ls()) # deletes all existing objects / variables !!

# Prog.Start <- Sys.time()

theme_replace(
  plot.title = element_text(
    hjust = 0.5, face = "bold.italic", color = "darkcyan", size = 12),
  plot.subtitle = element_text(
    hjust = 0.5, face = "italic", color = "darkcyan")
)
x_axis_theme <- element_text(size = 14)
```


```{r settings}

countries_eu <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus",
                  "Czech Republic", "Denmark", "Estonia", "Finland", "France",
                  "Germany", "Greece", "Hungary", "Ireland", "Italy",
                  "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands",
                  "Poland", "Portugal", "Romania", "Slovakia", "Slovenia",
                  "Spain", "Sweden")

compare_countries <- c("Austria", "France", "Germany", "Italy", "India",
                       "Japan", "Spain", "EU", 
                        "United Kingdom", "United States of America")
countries <- c("China", compare_countries)
countries_exp_growth <- c("World", "China", "Austria", "France", "Germany", "Italy", 
                       "India", "Spain", "EU",  "United States of America")
country_select <- "Germany"

span <- 7 #  for rolling mean over 7 days
q <- floor(span/2) # since 2q +1 = span !

range_reg_short <- 7 # days; at least one week is necessary to get rid of weekly 
    # fluctuations, important - no case values = 0 are allowed => log(0) = inf !
range_reg_long <- 21 # days; 2 or 3 weeks if one week is to short
                           # e.g. confidence levels to large !!
# whole week is necessary to get rid of weekly fluctuations
range_forcast <- 14  # 14days forecast => unclass(last_date + 1 + range_forcast -1)

range_cfr <- 14  # 14days cfr past period length
lag_n <- 12  # average lag for confirmed -> death - for all countries

```


```{r path on desktop PC, eval = TRUE}

corona_confirmed <- 
  read_csv(paste0(data_path, "/time_series_covid19_confirmed_global.csv")) %>%
  mutate(Case_Type = "Confirmed")
corona_deaths <- 
  read_csv(paste0(data_path, "/time_series_covid19_deaths_global.csv"))  %>%
  mutate(Case_Type = "Deaths")
corona_recovered <- 
  read_csv(paste0(data_path, "/time_series_covid19_recovered_global.csv")) %>%
  mutate(Case_Type = "Recovered")
```


```{r read data bind rows and chanfge to long format}

corona <- bind_rows(corona_confirmed, corona_deaths, corona_recovered) %>%
  pivot_longer(cols = c(-`Province/State`, -`Country/Region`, -Case_Type, 
                        -Lat,  -Long ), 
               names_to = c("Date"),
               values_to = "Cases")

corona <- corona %>% 
  mutate(Date = as.Date(Date, format = "%m/%d/%y")) %>% 
  rename(Country = `Country/Region`) 

```


```{r data clean-up}

# clean-up column names
# corona %>% janitor::clean_names()

# clean-up names of column Country / denmark "regions" to country 
# same country names for covid-19 data and population_countries are needed
# names have to fit to names used by
# https://code.highcharts.com/mapdata/ => 
# World with Palestine areas, high resolution Demo  => Highmaps basic demo
corona <- corona %>% 
  mutate(
    Country = case_when(
      Country == "Burma" ~ "Myanmar",
      Country == "Mainland China" ~ "China",
      Country == "Czechia" ~ "Czech Republic",
      Country == "Denmark" & `Province/State` == "Greenland" ~ "Greenland",
      Country == "Denmark" & `Province/State` == "Faroe Islands" ~ "Faroe Islands",
      Country == "Guinea-Bissau" ~ "Guinea Bissau",
      Country == "Hong Kong SAR" ~ "Hong Kong",
      Country == "Holy See" ~ "Holy See (Vatican City)",
      Country == "Iran (Islamic Republic of)" ~ "Iran",
      Country == "Macao SAR" ~ "Macao",
      Country == "occupied Palestinian territory" ~ "Palestine",
      Country == "Republic of Korea" ~ "South Korea",
      Country == "Cote d'Ivoire" ~ "Ivory Coast",
      Country == "Congo (Brazzaville)" ~ "Republic of Congo",
      Country == "Congo (Kinshasa)" ~ "Democratic Republic of the Congo",
      Country == "Korea, South" ~ "South Korea",
      Country == "Serbia" ~ "Republic of Serbia",
      Country == "North Macedonia" ~ "Macedonia",
      Country == "Eswatini" ~ "Swaziland",
      Country == "Taiwan*" ~ "Taiwan",
      Country == "Tanzania" ~ "United Republic of Tanzania",
      Country == "US" ~ "United States of America",
      Country == "Viet Nam" ~ "Vietnam",
      TRUE ~ as.character(Country)))

# clean-up content of column `Province/State`
# replace NAs by Country
# replace "Bavaria"  by  Country since `Province/State` exists only until 
# end of January, as begin of February inluded in "Germany" data
# `Province/State` == "Bavaria" ~ Country, not needed in time series format,
#  needed for data file: covid_19_data.csv
corona <- corona %>%  mutate(    
  `Province/State` = case_when(
    is.na(`Province/State`) ~ Country,
    TRUE ~ `Province/State`)) %>% 
  arrange(Country, `Province/State`) %>% 
  group_by(Case_Type, Country, `Province/State`)

# View(corona %>% dplyr::filter(Date == last_date & Case_Type == "Confirmed"))
```


```{r provinces data to country and add country world}
# add all data from provinces to country data 
corona_country <- corona %>% 
  group_by(Country, Date, Case_Type) %>% 
  summarise(Cases = sum(Cases, na.rm = TRUE))
corona_country %<>% 
  group_by(Country, Case_Type) %>% 
  mutate(Daily_Cases = c(NA, diff(Cases)))

# without Case_Type "Recovered"  - no real value add, no consistent data
corona_country %<>% dplyr::filter(Case_Type != "Recovered")

# first_date <- min(corona_country$Date)
# last_date <- max(corona_country$Date)
# View(corona_country %>% dplyr::filter(Date == last_date & Case_Type == "Confirmed"))

```

```{r add country World}

### provide sum of all countries as country "World" data
# for sum( , na.rm = TRUE) removing missing values is important,
# otherwise one region with NA (no cases) resulty in NA worldwide
corona_country_sum <- corona_country %>% 
  group_by(Date, Case_Type) %>% 
  summarise(Cases = sum(Cases, na.rm = TRUE))
corona_country_sum %<>% 
  group_by(Case_Type) %>% 
  mutate(Daily_Cases = c(NA, diff(Cases)),
         Country = "World")

corona_country <- bind_rows(corona_country, corona_country_sum)

```


```{r add country EU}
### provide sum of all EU countries as country "EU" data

corona_country_sum <- corona_country %>% 
  dplyr::filter(Country %in% countries_eu) %>% 
  group_by(Date, Case_Type) %>% 
  summarise(Cases = sum(Cases, na.rm = TRUE))
corona_country_sum %<>% 
  group_by(Case_Type) %>% 
  mutate(Daily_Cases = c(NA, diff(Cases)),
         Country = "EU")

corona_country <- bind_rows(corona_country, corona_country_sum)

```



```{r add population per country to data}

# add world population and normalize Confirmed and Deaths per 100k inhabitants

population_countries <- population_countries %>%
  dplyr::select(Country, Population)
# note: delects Type which provides split "Country" vs. "Region" for World & EU

corona_data <- full_join(corona_country, population_countries) 

corona_data %<>% dplyr::filter(!is.na(Date)) %>% 
  mutate(Cases_100k = round(Cases/(Population/100000), digits = 1),
         Daily_Cases_100k = round(Daily_Cases/(Population/100000), digits = 2))

```

```{r add rolling mean  per country to data}

# slide_dbl() => rolling mean double value, changed to before only
#                             no longer centered with .before = .after
# note: for last date rolling mean before is needed, otherwise all are NA
corona_data %<>% 
  group_by(Country, Case_Type) %>% 
  mutate(Daily_Cases_Mean =  round(
    slider::slide_dbl(Daily_Cases,  ~ mean(.),
                      .before = 2*q, .after = 0, .complete = TRUE),
    digits = 1),
    Daily_Cases_100k_Mean = round(
      slider::slide_dbl(Daily_Cases_100k,  ~ mean(.), 
                        .before = 2*q, .after = 0, .complete = TRUE),
      digits = 2)) %>% 
  ungroup()

corona_data <- corona_data  %>%
  tsibble::as_tsibble(index = Date, key = c(Country, Case_Type))

```

```{r}

saveRDS(corona_data, "./corona_data.RDS")
# corona_data <- readRDS("corona_data.RDS")

first_date <- min(corona_data$Date)
last_date <- max(corona_data$Date)
```


```{r complete data wide format}
# wide format: 
#    Country Population Date  Confirmed Daily_Conf ... Death ...
# for easy to read datatable outputs e.g.with filter for last date

corona_data_wide <- uts_get_corona_data_wide(corona_data)

# View(corona_data_wide %>%  dplyr::filter(Date == last_date))
```

```{r}

corona_data_last <- corona_data %>%
  dplyr::filter(Date == last_date)

corona_data_last_wide <- corona_data_wide %>%
  dplyr::filter(Date == last_date)

corona_last_abs_wide <- corona_data_last_wide %>% 
  dplyr::select(!contains("_100k"), -Population)

corona_last_rel_wide <- corona_data_last_wide %>% 
  dplyr::select(Country, Date, contains("_100k"))
```


```{r calculate lagged CFR}
## `cfr_table` - calculate Case Fatality Rate (CFR in %) -----------------------
#   assuming a time lag of `lag_n`-days (~12) between Confirmed => Death
#   - CFR_past_period - past 14 days
#   - CFR_total
#   - CFR_unlagged (unlagged total)

corona_confirmed_lag <- corona_data_wide %>% 
  tibble::tibble() %>% 
  # for a tsibble select() would not deselect 'Date' column => join() issue
  # and target is a last date table only
  dplyr::select(!contains("_100k"), -Population, 
                -Daily_Conf, -Daily_Deaths) %>% 
  mutate(confirmed_lag = lag(Confirmed, lag_n),
         CFR_total = round(Deaths / confirmed_lag * 100, digits = 1),
         CFR_unlagged = round(Deaths / Confirmed * 100, digits = 1)) 

corona_total_CFR_lag <- corona_confirmed_lag %>% 
  dplyr::filter(Date == last_date) 

corona_before <- corona_confirmed_lag %>% 
  dplyr::filter(Date == last_date - range_cfr + 1) %>% 
  mutate(Deaths_before = Deaths,
         confirmed_lag_before = confirmed_lag) %>% 
  dplyr::select(Country, Deaths_before, confirmed_lag_before) 

cfr_table <- left_join(corona_total_CFR_lag, corona_before) %>% 
  mutate(confirmed_past_period = confirmed_lag - confirmed_lag_before,
         deaths_past_period = Deaths - Deaths_before,
         CFR_past_period = round(
           deaths_past_period / confirmed_past_period * 100, digits = 1)) %>% 
  select(Country,  CFR_past_period, CFR_total, CFR_unlagged)

```


```{r map and bar chart settings}

page_2 <- "Cumulative Cases per 100,000 Inhabitants"
page_3 <- "Mean number of cases over the past seven days per 100,000 Inhabitants"
page_4 <- paste("Case Fatality Rate - CFR of past", range_cfr, 
                "days and CFR_total assuming a time lag of", lag_n, 
                "days between Confirmed => Death")

map_page_title_1 <- paste("World Map - Spread of Coronavirus SARS-CoV-2",
                        "(Data source [[@JHU2020a]](#bib), see also [[@JHU2020]](#bib))")
map_page_title_2 <- paste("World Map -",  page_2)
map_page_title_3 <- paste("World Map -",  page_3)
map_page_title_4 <- paste("World Map -",  page_4)

bar_chart_page_title_1 <- paste("Bar Chart (descending order) and Data Table")
bar_chart_page_title_2 <- paste("Bar Chart -",  page_2)
bar_chart_page_title_3 <- paste("Bar Chart -",  page_3)
bar_chart_page_title_4 <- paste("Bar Chart -",  page_4)
  
```

```{r, eval=FALSE}

# include for every flexdashboard page an own Rmd child

```


```{r Add Page_world_map, child = 'Page_world_map.Rmd'}
```


```{r Add Page_bar_chart, child = 'Page_bar_chart.Rmd'}
```


```{r Add Page_cumulative_and_daily_trend., child = 'Page_cumulative_and_daily_trend.Rmd'}
```


```{r Add Page_exp_linear_growth, child = 'Page_exp_linear_growth.Rmd'}
```


```{r Add Page_forecast, child = 'Page_forecast.Rmd'}
```


References {#bib}
=====================================

***
***
  
### Data and Code Sources {data-height=400}

**Data Source**

Data files are provided by **Johns Hopkins University** on GitHub  
<https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series>

* Data files:  
    + *time_series_covid19_confirmed_global.csv* 
    + *time_series_covid19_deaths_global*
    + *time_series_covid19_recovered_global.csv*

The data are visualized on their Dashboard  
**Johns Hopkins University Dashboard**  
<https://coronavirus.jhu.edu/map.html>


**Code Source**

GitHub link for repository of 

* *Corona_Virus_TS_Dashboard.Rmd* R Markdown source file
    + *Page_world_map.Rmd* R Markdown child file
    + *Page_bar_chart.Rmdd* R Markdown child file
    + *Page_cumulative_and_daily_trend.Rmd* R Markdown child file
    + *Page_exp_linear_growth.Rmd* R Markdown child file
* *world_population_un.RDS* R object file with UN world population data
* *References_Corona.bib* Bibtex file providing the references with the Bibtexkeys

<https://github.com/WoVollmer/R-TimesSeriesAnalysis/tree/master/Corona-Virus>


GitHub link for repository of

* R package `pkgTS` providing functions for the **T**ime **S**eries analysis.

<https://github.com/WoVollmer/pkgTS>

R installation by calling

* `install.packages("devtools")`
* `devtools::install_github("WoVollmer/pkgTS")`

The required R files are

* `ggts_corona.R` - providing the functions to create the plots
* `uts_corona.R`  - providing utility functions

### Bibliography

