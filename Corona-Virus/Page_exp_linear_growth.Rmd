---
title: "Coronavirus SARS-CoV-2 / Covid-19"
author: "Wolfgang Vollmer"
date: '`r Sys.Date()`'
link-citations: yes
cite-color: "green"
bibliography: References_Corona.bib
output:
  flexdashboard::flex_dashboard:
  vertical_layout: scroll
params:
  device: "desktop"
---


```{r config with rds data, child = 'Corona_Virus_config.Rmd', eval = FALSE}
```



```{r}

fig_asp_trend <- 0.35

```

Cumulated Cases on log10 scale {data-navmenu="Exp Linear Growth"}
=====================================

***
***


Column {data-width=100}
-------------------------------------

### Exponential Growth Cumulated Cases

China and South Korea slowed down exponential growth significantly at an early stage. Their lines on log10 scale have had no longer a significant slope.
 
In early phases countries have a more or less unchecked exponential
growth. 
If countermeasures are effective, reduced exponential growth is reflected in a 
reduced slope of the cumulative cases again.

Column
-------------------------------------

### Virus Spread - Cumulative Cases on log10 scale

```{r}

labels_scale <- c(0.1, 0.5, 1, 5, 100, 1000, 5000, 10000, 50000, 100000, 
                  500000, 1000000, 5000000, 10000000)

```


```{r plot log10scale w/o date filter, fig.width = 14, fig.asp = 0.8}

# logscale plot w/o date filter
# ylim min setting by Cases rsp. Cases_100k > ymin; ylim for facet not usable
data <- corona_data %>% 
  dplyr::filter(Country %in% compare_countries[c(2:4, 7:10)] & 
                  Cases >= 100 & Cases_100k > 0.3) %>% 
  dplyr::select(Date, Country, Case_Type, Cases, Cases_100k)

plot_1 <- ggts_logscale(data, y = Cases) + 
  scale_y_continuous(breaks = log10(labels_scale), labels = labels_scale) +
  labs(title = "Cumulative Cases") +
  geom_line(size = 1) +
  facet_wrap(vars(Case_Type), ncol = 1, scales = "free_y",
             strip.position = "left")

##  plot per 100,000 inhabitants
plot_2 <- ggts_logscale(data, x = Date, y = Cases_100k) + 
  scale_y_continuous(breaks = log10(labels_scale), labels = labels_scale) +
  labs(title = "Cumulative Cases / 100k Inhabitants") +
  geom_line(size = 1) +
  facet_wrap(vars(Case_Type), ncol = 1, scales = "free_y",
             strip.position = "left") 


plot_1 + plot_2 + 
  plot_annotation(title = "Virus Spread - Selected Countries") +
  plot_layout(guides = 'collect') & theme(legend.position = 'bottom')

```



Daily Cases on log10 scale {data-navmenu="Exp Linear Growth"}
=====================================

***
***


Column {data-width=100}
-------------------------------------

### Exponential Growth Daily Cases

In early phases countries have a more or less unchecked exponential
growth resulting in a significant curve slope for the daily cases.

Successful countermeasures are reflected in a reduced exponential growth, 
the slope of the curve decreases.

In the steady state, the slope disappears and if the daily cases decrease,
the slope becomes negative.

Column
-------------------------------------

### Virus Spread - Daily Cases on log10 scale

```{r plot daily log10scale w/o date filter, fig.width = 14, fig.asp = 0.8}

# logscale plot w/o date filter
data <- corona_data %>% # ungroup() %>% group_by(Case_Type) %>% 
  dplyr::filter(Country %in% compare_countries[c(2:4, 7:10)] & 
                  Mean_Daily_Cases_100k > 0.01) %>% 
  dplyr::select(Date, Country, Case_Type, 
                Mean_Daily_Cases, Mean_Daily_Cases_100k)

plot_1 <- ggts_logscale(data, y = Mean_Daily_Cases) +
  geom_line(size = 1) +
  scale_y_continuous(breaks = log10(labels_scale), labels = labels_scale) +
  labs(title = "Mean_Daily Cases") +
  facet_wrap(vars(Case_Type), ncol = 1, scales = "free_y",
             strip.position = "left")

##  plot per 100,000 inhabitants
plot_2 <- ggts_logscale(data, x = Date, y = Mean_Daily_Cases_100k) + 
  geom_line(size = 1) +
  scale_y_continuous(breaks = log10(labels_scale), labels = labels_scale) +
  labs(title = "Mean_Daily Cases / 100k Inhabitants") +
  facet_wrap(vars(Case_Type), ncol = 1, scales = "free_y",
             strip.position = "left") 

plot_1 + plot_2 + 
  plot_annotation(title = "Virus Spread - Selected Countries") +
  plot_layout(guides = 'collect') & theme(legend.position = 'bottom')

```



Exponential Growth {data-navmenu="Exp Linear Growth"}
=====================================

***
***

Column {data-width=400}
------------------------------------  

### Estimation spread of the Coronavirus with Linear Regression of log data

**Exponential Growth and Doubling Time $T$**

Exponential growth over time can be fitted by linear regression if the logarithms
of the case numbers is taken. Generally, exponential growth corresponds to
linearly growth over time for the log (to any base) data 
[[see also @Wikipedia2020]](#bib). 

The semi-logorithmic plot with base-10 log scale for the Y axis shows 
functions following an exponential law $y(t) = y_0 * a^{t/\tau}$
as straight lines. The time constant $\tau$ describes the time required for y to increase by one factor of $a$. 

If e.g. the confirmed or death cases are growing in $t-days$ by a factor of $10$
the doubling time $T \widehat{=} \tau$ can be calculated with $a \widehat{=} 2$ by

<p style="text-align: center;">
$T[days] = \frac {t[days] * log_{10}(2)} {log_{10}(y(t))-log_{10}(y_0)}$
</p>

with    
<p style="text-align: center;">
$log_{10}(y(t))-log_{10}(y_0) = = log_{10}(y(t))/y_0) = log_{10}(10*y_0/y_0) = 1$  
</p>

and doubling time   
<p style="text-align: center;">
$T[days] = t[days] * log_{10}(2) \approx t[days] * 0.30$.
</p>

For Spain, Italy, Germany we have had a doubling time of only $T \approx 9days * 0.3 \approx 2.7 days$ at the beginning of the pandemic!!. 

The *doubling time $T$* and the *Forecast* is calculated for following
selected countries: **`r compare_countries`** and **World** in total 
(see [Forecast / Doubling Time](#doubling)).


### `r country_select` - Trend with Forecast on a linear scale


```{r corona range_reg_long}

# # provide tsbl of range_reg_short for linear regression of log data
# corona_range_reg_short <- corona_data %>% 
#   group_by(Case_Type) %>% 
#   dplyr::filter(Country %in% c("World", compare_countries) & 
#            Date >= last_date - range_reg_short + 1) %>% 
#            # Case_Type != "Recovered" & Cases >= 10) %>% 
#   dplyr::select(Date, Country, Case_Type, Cases)


# provide tsbl of range_reg_long for linear regression of daily log data
corona_range_reg_long <- corona_data %>% 
  group_by(Case_Type) %>% 
  dplyr::filter(Country %in% c("World", compare_countries) & 
           Date >= last_date + 1 - range_reg_long) 

```


```{r example, fig.width = 10, fig.height = 5}


fit_corona <- corona_range_reg_long %>%  
  model(TSLM(log(Mean_Daily_Cases) ~ Date)) 
fc_corona <- fit_corona %>% 
  fabletools::forecast(h = "14 days") 

fc_corona %>%  
  dplyr::filter(Country == country_select) %>% 
  autoplot(corona_range_reg_long) +
  ggtitle(paste(country_select, "- Cases and 14-days Forecast (linear y-scale)"),
          subtitle = paste(
            "Forecast is based on regression of past ",
            range_reg_long, " days")) +
  labs(x = "Days") +
  # scale_y_log10() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  facet_wrap(~ Case_Type, ncol = 2,  scales = "free_y",
             strip.position = "left")


```


### Forecast Plot - next `r range_fc_long` days {data-height=150}

The plot shows the daily cases forecast increase in case of unchecked 
exponential growth. 
The dark shaded regions show the 80% rsp. 95% prediction intervals. 
These prediction intervals are displaying the uncertainty in forecasts 
based on the linear regression of the logarithmic data over the past
`r range_reg_long` days.

Column {data-width=600}
------------------------------------ 

### Comparison Exponential Growth (Daily rolling mean cases on log10 scale)


```{r plot log10scale selected Country}

# gg_plot <- ggts_logscale(corona_data_range_reg)  +
#   geom_smooth(method="lm", aes(col = Country), lty = "dashed", se=FALSE)
gg_plot <- ggts_logscale(corona_range_reg_long, y = Mean_Daily_Cases)  +
  geom_smooth(method="lm", aes(col = Country), lty = "dashed", se=FALSE) 
  
gg_plot +
  scale_y_continuous(breaks = log10(labels_scale), label = labels_scale) +
  labs(subtitle = paste("Past", range_reg_long, "days with Linear Regression of log data"))
                # changed from: range_reg
```



### Germany - Cumulative cases with ~linear slope on a log10 scale {data-height=400}

```{r  Plot with Linear Regression}
# plot with linear regression on log scale
# linear regression of the logarithmic data for the past seven days
# 
for (i in country_select) { 
  plot_cases <- 
    ggts_trend_facet(corona_data %>% dplyr::filter(Country == i & Cases >= 10)) +
    labs(title = paste(i, "- Cumulative Cases")) +
    scale_y_log10()
  plot_cases_past_weeks <- 
    ggts_trend_facet(corona_data %>% dplyr::filter(Country == i & Cases >= 10 &
                                                    Date >= last_date - 28 + 1)) +
    labs(title = paste(i, "- Cumulative Cases (past 28 days"), 
         subtitle = paste("w/ linear regression of log data for past", 
                          range_reg_short, "days"))  +
    geom_smooth(data = corona_data %>% 
                  dplyr::filter(Country == i & Case_Type != "Recovered" & 
                           Date >= last_date + 1 - range_reg_short), 
                method="lm", 
                col = "black", size = 1, se = FALSE) +
    scale_y_log10() +
    scale_x_date(date_labels = "%b %d", date_breaks = "7 days")
  # gridExtra::grid.arrange(plot_cases, plot_daily_cases, ncol = 2)
  print(plot_cases + plot_cases_past_weeks) 
}

```

Compare Exp vs Linear Growth {data-navmenu="Exp Linear Growth"}
=====================================

***
***


Column {data-width=150}
-------------------------------------

### Comparison Exponential vs. Linear Growth

The charts compare the different forecasts for an exponential rsp. linear growth 
model. Due to the large fluctuations of the daily cases regression of three 
weeks is required. Otherwise the prediction levels are much too big.

The dark shaded regions are indicating the $80\%$ rsp. $95\%$  prediction 
intervals. These prediction intervals are displaying the "pure" statistical 
uncertainty in forecasts based on the regression models.

For doubling periods in the order of period of infectivity
(RKI assumption: $\sim9-10$ days, with great uncertainty, 
see [[@RKI2020b]](#bib), we no longer have exponential growth. 
The "old" infected cases are at the end of the doubling period no longer 
infectious (active). 
This results in a constant infection rate with basic reproduction number
$R_t \sim 1$ or even $<1$.

Note: for case numbers of German federal states see [[@RKI2020]](#bib).


Column
-------------------------------------
### Daily Rolling Mean Cases - Comparison Exponential and Linear Growth

```{r daily forecast linear model, fig.asp = fig_asp_trend}

forecast_days <- paste(range_fc_short, "days")

fit_daily_corona <- corona_range_reg_long %>%
  group_by(Case_Type) %>% 
  model(Exp_Growth = TSLM(log(Mean_Daily_Cases) ~ Date),
        Linear_Growth = TSLM(Mean_Daily_Cases ~ Date)) 

fc_daily_corona <- fit_daily_corona %>% 
  fabletools::forecast(h = forecast_days) 

fc_daily_corona %>%  
  dplyr::filter(Country == country_select) %>% 
  autoplot(corona_range_reg_long) +
  labs(title = paste(
    country_select, " - Forecast of Mean Daily Cases for the next ", 
    range_fc_short, "-days"),
    subtitle = paste(
      "Forecast is based on regression of past ",
      range_reg_long, " days")) +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  facet_wrap(~ Case_Type, ncol = 2,  scales = "free_y",
             strip.position = "left")

```


### Cumulative Cases - Comparison Exponential and Linear Growth

```{r daily forecast exp growth, fig.asp = fig_asp_trend}

fit_cum_corona <- corona_range_reg_long %>%
  group_by(Case_Type) %>% 
  model(Exp_Growth = TSLM(log(Cases) ~ Date),
        Linear_Growth = TSLM(Cases ~ Date)) 

fc_cum_corona <- fit_cum_corona %>% 
  fabletools::forecast(h = forecast_days) 


fc_cum_corona %>%  
  
  dplyr::filter(Country == country_select) %>% 
  autoplot(corona_range_reg_long) +
  labs(title = paste(
    country_select, " - Forecast of Cumulative Cases for the next ", 
    range_fc_short, "-days"),
    subtitle = paste(
      "Forecast is based on regression of past ",
      range_reg_long, " days")) +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  facet_wrap(~ Case_Type, ncol = 2,  scales = "free_y",
             strip.position = "left")

```

